name: CI/CD with Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    name: Build, Test & Enforce Coverage
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ§° Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore

      - name: ğŸ—ï¸ Build solution
        run: dotnet build --no-restore --configuration Release

      - name: ğŸ§ª Run tests with coverage
        run: |
          dotnet test TranslatorTracker/src/trans.tracker.lb/trans.tracker.lb.tests/trans.tracker.lb.tests.csproj \
            --no-build \
            --configuration Release \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=cobertura \
            /p:Exclude="[xunit.*]*" \
            /p:Include="[trans.tracker.lb*]*" \
            /p:CoverletOutput=TestResults/coverage

      - name: ğŸ“Š Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: ğŸ“ˆ Generate coverage report
        run: |
          reportgenerator \
            -reports:TestResults/coverage/coverage.cobertura.xml \
            -targetdir:CoverageReport \
            -reporttypes:HtmlSummary;TextSummary

      - name: ğŸ›¡ï¸ Enforce 50% minimum coverage
        run: |
          summary=$(cat CoverageReport/Summary.txt | grep "Line coverage" | head -n1)
          echo "Coverage Summary: $summary"
          percent=$(echo "$summary" | grep -oE "[0-9]+\.[0-9]+")
          echo "Extracted percent: $percent"
          coverage=${percent%.*}
          if [ "$coverage" -lt 50 ]; then
            echo "âŒ Code coverage is below 50% ($coverage%)"
            exit 1
          else
            echo "âœ… Code coverage is sufficient ($coverage%)"
          fi

      - name: ğŸ“¤ Upload HTML coverage report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: CoverageReport
